---
title: "Analyze simulation results"
author: "`r Sys.info()[['user']]`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  github_document:
    toc: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = F, warning = F)
```

## Load libraries
```{r}
library(tidyverse)
library(rasilabRtemplates)
# disable scientific notation
options(scipen=999)

cleave_model_names <- c(
  "hit5" = "CSEC",
  "simple" = "SEC",
  "trafficjam" = "TJ"
)
```

# Read protein count data

```{r}
psr_data <- read_tsv("tables/psr_stats.tsv") %>% 
  print()
```

# Read mRNA lifetime data

```{r}
lifetime_data <- read_tsv("tables/mrna_lifetime_stats.tsv") %>% 
  mutate(se_lifetime = sd_lifetime / sqrt(n_mrna)) %>% 
  print()
```

# Read collision data

```{r}
collision_data <- read_tsv("tables/collision_stats.tsv") %>% 
  select(-mean_p_per_m, -sd_p_per_m) %>% 
  print()
```

# Read abort data

```{r}
abort_data <- read_tsv("tables/abort_stats.tsv") %>% 
  filter(str_detect(rxn_type, "intact")) %>% 
  group_by(sim_id) %>%
  summarize(mean_abort_per_m = sum(mean_abort_per_m), abort_freq = sum(abort_freq)) %>%
  ungroup() %>%
  print()
```
# Read simulation parameters

```{r}
sim_params <- read_tsv("sim.params.tsv") %>% 
  rename(sim_id = X1) %>% 
  mutate(k_elong_stall = str_split(k_elong_stall, ",")) %>%
  mutate(k_elong_stall = map(k_elong_stall, as.numeric)) %>%
  mutate(k_elong_stall = map(k_elong_stall, function(x) unique(x))) %>%
  unnest() %>%
  mutate(x_stall = stringr::str_split(x_stall, ',')) %>%
  mutate(k_stall = round(k_elong_stall / as.numeric(n_stall), 2)) %>%
  select(sim_id, cleave_rate, cleave_model, k_stall, preterm_intact_rate, preterm_intact_model) %>%
  print()

annotations <- list.files("output/", pattern = "params.tsv.gz$", full.names = T) %>%
  enframe("sno", "file") %>%
  mutate(sim_id = str_extract(file, "(?<=tasep_)[[:digit:]]+")) %>%
  mutate(data = map(file, read_tsv)) %>%
  select(-file, -sno) %>%
  unnest() %>%
  type_convert() %>%
  # retain only parameters that are varied, the others are for checking
  group_by(parameter) %>%
  mutate(vary = if_else(length(unique(value)) > 1, T, F)) %>%
  ungroup() %>%
  filter(vary == T) %>%
  select(-vary) %>%
  spread(parameter, value) %>%
  left_join(sim_params, by = "sim_id") %>%
  print()
```

# Combine all data into a single table

```{r}
data <- annotations %>% 
  left_join(psr_data, by = "sim_id") %>% 
  left_join(lifetime_data, by = "sim_id") %>% 
  left_join(collision_data, by = "sim_id") %>% 
  left_join(abort_data, by = "sim_id") %>% 
  mutate(abort_freq = if_else(is.na(abort_freq), 0, abort_freq)) %>% 
  mutate(mean_abort_per_m = if_else(is.na(mean_abort_per_m), as.integer(0), mean_abort_per_m)) %>% 
  group_by(preterm_intact_rate, k_init) %>% 
  arrange(cleave_rate) %>% 
  mutate(cleave_order = 1:n()) %>% 
  ungroup() %>% 
  mutate(model = cleave_model_names[cleave_model]) %>%
  mutate(preterm_intact_rate = as.factor(preterm_intact_rate)) %>%
  mutate(cleave_order = as.factor(cleave_order)) %>%
  print()
```

# mRNA lifetime as a function of initiation rate for different rates of premature termination

```{r, fig.width=5.4, fig.height=4.2}
plot_data <- data %>% 
  group_by(cleave_rate, preterm_intact_rate, model) %>% 
  mutate(mean_lifetime = mean_lifetime / max(mean_lifetime)) %>% 
  mutate(psr = psr / max(psr)) %>% 
  ungroup() %>% 
  print()

plot_data %>%
  ggplot(aes(x = k_init, y = mean_lifetime, color = cleave_order, shape = model, group = cleave_order)) +
  facet_wrap(~ preterm_intact_rate, ncol = 3, labeller = label_both) +
  geom_point(size = 2) +
  geom_line() +
  scale_x_continuous(trans = "log2",
                     labels = scales::trans_format("log2", scales::math_format(2^.x)),
                     breaks = 2^(seq(-8,0,2))) +
  # scale_color_manual(values = cbPalette[c(3,2)]) +
  viridis::scale_color_viridis(discrete = T) +
  scale_shape_manual(values = c(19, 17)) +
  labs(x = "initiation rate (s-1)", y = "mean mRNA lifetime (s)", color = "", shape = "") +
  theme(legend.position = "top")

# ggsave("figures/mrna_lifetime_vs_initiation_rate.pdf", width = 1.7, height = 2)
```

# mRNA lifetime as a function of initiation rate for different rates of premature termination, Reviewer response figure 

```{r, fig.width=3.2, fig.height=2.2}
plot_data <- data %>% 
  filter(cleave_order == 2) %>% 
  print()

plot_data %>%
  ggplot(aes(x = k_init, y = mean_lifetime, color = preterm_intact_rate, group = preterm_intact_rate)) +
  geom_point(size = 2) +
  geom_line() +
  scale_x_continuous(trans = "log2",
                     labels = scales::trans_format("log2", scales::math_format(2^.x)),
                     breaks = 2^(seq(-8,0,2))) +
  labs(x = "initiation rate (s-1)", y = "mean mRNA lifetime (s)", color = "", shape = "") +
  viridis::scale_color_viridis(discrete = T)

# ggsave("figures/mrna_lifetime_vs_initiation_rate.pdf", width = 1.7, height = 2)
```
# PSR as a function of initiation rate

```{r, fig.width=5.4, fig.height=4.2}
plot_data <- data %>% 
  group_by(cleave_rate, preterm_intact_rate, model) %>% 
  mutate(mean_lifetime = mean_lifetime / max(mean_lifetime)) %>% 
  mutate(psr = psr / max(psr)) %>% 
  ungroup() %>% 
  print()

plot_data %>%
  ggplot(aes(x = k_init, y = psr, color = cleave_order, shape = model, group = cleave_order)) +
  facet_wrap(~ preterm_intact_rate, ncol = 3, labeller = label_both) +
  geom_point(size = 2) +
  geom_line() +
  scale_x_continuous(trans = "log2",
                     labels = scales::trans_format("log2", scales::math_format(2^.x)),
                     breaks = 2^(seq(-8,0,2))) +
  # scale_color_manual(values = cbPalette[c(3,2)]) +
  viridis::scale_color_viridis(discrete = T) +
  scale_shape_manual(values = c(19, 17)) +
  labs(x = "initiation rate (s-1)", y = "protein synthesis rate (s-1)", color = "", shape = "") +
  theme(legend.position = "top")
```

# PSR as a function of initiation rate for different rates of premature termination, Reviewer response figure 

```{r, fig.width=3.2, fig.height=2.2}
plot_data <- data %>% 
  filter(cleave_order == 2) %>% 
  print()

plot_data %>%
  ggplot(aes(x = k_init, y = mean_p_per_m, color = preterm_intact_rate, group = preterm_intact_rate)) +
  geom_point(size = 2) +
  geom_line() +
  scale_x_continuous(trans = "log2",
                     labels = scales::trans_format("log2", scales::math_format(2^.x)),
                     breaks = 2^(seq(-8,0,2))) +
  scale_y_continuous(limits = c(0, NA)) +
  viridis::scale_color_viridis(discrete = T) +
  labs(x = "initiation rate (s-1)", y = "full proteins / mRNA", color = "", shape = "")

# ggsave("figures/mrna_lifetime_vs_initiation_rate.pdf", width = 1.7, height = 2)
```

# Abort rate as a function of initiation rate for different rates of premature termination, Reviewer response figure 

```{r, fig.width=3.2, fig.height=2.2}
plot_data <- data %>% 
  filter(cleave_order == 2) %>% 
  print()

plot_data %>%
  ggplot(aes(x = k_init, y = mean_abort_per_m, color = preterm_intact_rate, group = preterm_intact_rate)) +
  geom_point(size = 2) +
  geom_line() +
  scale_x_continuous(trans = "log2",
                     labels = scales::trans_format("log2", scales::math_format(2^.x)),
                     breaks = 2^(seq(-8,0,2))) +
  scale_y_continuous(limits = c(0, NA)) +
  viridis::scale_color_viridis(discrete = T) +
  labs(x = "initiation rate (s-1)", y = "aborted proteins / mRNA", color = "", shape = "")

# ggsave("figures/mrna_lifetime_vs_initiation_rate.pdf", width = 1.7, height = 2)
```